---
export const prerender = false;

import Layout from '../../../layouts/Layout.astro';
import NavbarV2 from '../../../components/NavbarV2.astro';
import Hero from '../../../components/Hero.astro';
import EventDetails from '../../../components/EventDetails.astro';
import GuestWishes from '../../../components/GuestWishes.astro';
import RSVP from '../../../components/RSVP.astro';
import Footer from '../../../components/Footer.astro';
import CoupleSection from '../../../components/CoupleSection.astro';
import { supabase } from '../../../lib/supabase.client';

// Ambil slug dari URL
const { slug } = Astro.params;

let guestName = "Tamu Spesial";

if (slug) {
  // Pastikan slug lowercase agar match dengan database
  const safeSlug = slug.toLowerCase();
  
  console.log("Fetching guest for slug (v2):", safeSlug);

  const { data, error } = await supabase
    .from('guests')
    .select('name')
    .eq('slug', safeSlug)
    .single();
  
  if (error) {
    console.error("Error fetching guest (v2):", error);
  }
  
  if (data) {
    console.log("Guest found (v2):", data.name);
    guestName = data.name;
  } else {
    console.log("No guest found (v2)");
  }
}
---

<Layout 
  title={`Undangan Pernikahan Bagas & Firda untuk ${guestName}`}
  description="Kami mengundang Bapak/Ibu/Saudara/i untuk turut berbagi kebahagiaan dalam pernikahan putra-putri kami"
>
  <!-- Navigation -->
  <NavbarV2 />

  <!-- Main Content -->
  <main>
    <!-- Hero Section -->
    <!-- Pass guestName ke Hero -->
    <Hero guestName={guestName} />

    <!-- Couple Section -->
    <CoupleSection isV2={true} />
    
    <!-- Event Details Section -->
    <EventDetails />

    <!-- Guest Wishes Section -->
    <GuestWishes />

    <!-- RSVP Section -->
    <RSVP />
  </main>

  <!-- Footer -->
  <Footer />
</Layout>
